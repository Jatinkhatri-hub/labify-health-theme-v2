{{ 'main-collection-product-grid.css' | asset_url | stylesheet_tag }}
{{ 'product-card.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  @font-face {
    font-family: 'Avenir Regular';
    src: url('{{'avenirRegular.woff2' | asset_url}}');
  }

  @font-face {
    font-family: 'Avenir Medium';
    src: url('{{'avenirMedium.woff2' |  asset_url}}')
  }

  @font-face {
    font-family: 'Avenir Bold';
    src: url('{{'avenir-bold.woff2' | asset_url}}');
  }

  @font-face {
    font-family: 'Avenir Light';
    src: url('{{'avenir-light.woff2' | asset_url}}');
  }


{%- endstyle -%}

{% comment %} {% assign product = section.settings.product %} {% endcomment %}

<div class="section-{{ section.id }}-padding gradient color-{{ section.settings.section_color_scheme }} custom-section review-section">
  <div class="page-width color-{{ section.settings.color_scheme }} review-section filter-page-width">
    <div class="main-grid__filter-wrapper">
    <form id="filter-form">
      {%- for filter in collection.filters -%}
        <details>
          <summary>
            <div class="main-grid__filter-box">
              <span>{{ filter.label }}</span>
              {% render 'icon-dropdown' %}
              {% comment %} {%- if filter.active_values.size > 0 -%}
                <span>({{ filter.active_values.size }})</span>
              {%- endif -%} {% endcomment %}
            </div>
          </summary>

          <div class="filter-box__dropdown-menu-wrapper">
            {% comment %} <div>
              <p>{{ filter.active_values.size }} selected</p>
              {%- if filter.active_values.size > 0 -%}
                <p>
                  <a href="{{ filter.url_to_remove }}">Reset</a>
                </p>
              {%- endif -%}
            </div> {% endcomment %}
            {%- case filter.type -%}
              {%- when 'boolean' -%}
                <ul>
                  <li>
                    <label for="Filter-{{ filter.param_name }}-{{ filter.true_value.value }}">
                      <input
                        type="checkbox"
                        name="{{ filter.param_name }}"
                        value="{{ filter.true_value.value }}"
                        id="Filter-{{ filter.param_name }}"
                        {% if filter.true_value.active -%}
                        checked{%- endif %}
                        {% if filter.true_value.count == 0 and filter.true_value.active == false -%}
                        disabled{%- endif -%}>{{ filter.true_value.label }}</label>
                  </li>
                  <li>
                    <label for="Filter-{{ filter.param_name }}-{{ filter.false_value.value }}">
                      <input
                        type="checkbox"
                        name="{{ filter.param_name }}"
                        value="{{ filter.false_value.value }}"
                        id="Filter-{{ filter.param_name }}"
                        {% if filter.false_value.active -%}
                        checked{%- endif %}
                        {% if filter.false_value.count == 0 and filter.false_value.active == false -%}
                        disabled{%- endif %}>{{ filter.false_value.label }}</label>
                  </li>
                </ul>

                <div>
                  <input type="submit" value="Apply">
                </div>
              {%- when 'list' -%}
                <ul class="filter-box__dropdown-menu">
                  {%- for filter_value in filter.values -%}
                    <li class="dropdown-menu__item">
                      <label class="dropdown-menu__item-lable" for="Filter-{{ filter.param_name }}-{{ forloop.index }}">
                        <input
                          type="checkbox"
                          name="{{ filter_value.param_name }}"
                          value="{{ filter_value.value }}"
                          id="Filter-{{ filter.param_name }}-{{ forloop.index }}"
                          {% if filter_value.active -%}
                          checked{%- endif %}
                          {% if filter_value.count == 0 and filter_value.active == false -%}
                          disabled{%- endif %}>
                        <span>
                          {%- case filter_value.display.type -%}
                            {%- when 'colors' -%}
                              {% liquid
                                assign size_limit = filter_value.display.value.size | at_most: 4
                                assign rotation = '0deg'
                                if size_limit == 2
                                  assign rotation = '45deg'
                                endif

                                assign angle_increment = 360 | divided_by: size_limit
                                assign angle = 0
                              %}
                              {%- capture conic_gradient -%}
                            {%- for color in filter_value.display.value limit: size_limit -%}
                              {{ color }} {{ angle }}deg{%- assign angle = angle | plus: angle_increment %} {{ angle }}deg{%- unless forloop.last %}, {%- endunless -%}
                            {%- endfor -%}
                          {%- endcapture -%}
                              <span style="
                            width: 25px;
                            height: 25px;
                            border-radius: 50%;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            background: conic-gradient({{ conic_gradient }}); transform: rotateZ({{ rotation }});
                          ">
                            </span>
                            {%- when 'image' -%}
                              {{
                                filter_value.display.value | image_url: width: 25 | image_tag: alt: filter_value.display.value.alt
                              }}
                            {%- else -%}
                              <span class="visual-display__child"></span>
                          {%- endcase -%}
                        </span>
                        {{ filter_value.label }}
                      </label>
                    </li>
                  {%- endfor -%}
                </ul>

                {% comment %} <div>
                  <input type="submit" value="Apply">
                </div> {% endcomment %}
              {%- when 'price_range' -%}
                <div class="filter-group-display__price-range">
                  <div class="filter-group-display__price-range-from">
                    <span>{{ cart.currency.symbol }}</span>

                    <input
                      name="{{ filter.min_value.param_name }}"
                      id="Filter-{{ filter.min_value.param_name }}"
                      {% if filter.min_value.value -%}
                      value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                      {%- endif %}
                      type="number"
                      placeholder="0"
                      min="0"
                      max="{{ filter.range_max | money_without_currency | replace: ',', '' }}">

                    <label for="Filter-{{ filter.min_value.param_name }}">From</label>
                  </div>
                  <div class="filter-group-display__price-range-to">
                    <span>{{ cart.currency.symbol }}</span>

                    <input
                      name="{{ filter.max_value.param_name }}"
                      id="Filter-{{ filter.max_value.param_name }}"
                      {% if filter.max_value.value -%}
                      value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                      {%- endif %}
                      type="number"
                      placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                      min="0"
                      max="{{ filter.range_max | money_without_currency | replace: ',', '' }}">

                    <label for="Filter-{{ filter.max_value.param_name }}">To</label>
                  </div>
                </div>

                <div class="filter-group-display__submit">
                  <input type="submit" value="Apply">
                </div>
            {%- endcase -%}
          </div>
        </details>
      {%- endfor -%}

      {% comment %} <details class="selected__filter-box">
        <summary>
          <a href="{{ collection.url }}?sort_by={{ collection.sort_by }}">All</a>
        </summary>

        {%- for filter in collection.filters -%}
          {%- if filter.type == "price_range" -%}
            {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
              <p>
                <a href="{{ filter.url_to_remove }}">
                  {%- assign min_value = filter.min_value.value | default: 0 -%}
                  {%- assign max_value = filter.max_value.value | default: filter.range_max -%}
                  {{ min_value | money }} - {{ max_value | money }} X
                </a>
              </p>
            {%- endif -%}
          {%- else -%}
          <div>
            {%- for filter_value in filter.active_values -%}
              <p>
                <a href="{{ filter_value.url_to_remove }}">
                  {{ filter.label }}: {{ filter_value.label }} X
                </a>
              </p>
            {%- endfor -%}
          </div>
          {%- endif -%}
        {%- endfor -%}
      </details>  {% endcomment %}
    </form>
      <div class="selected-filters-dropdown mobile">
        <button class="dropdown-toggle">Selected Filters </button>
          {% render 'icon-dropdown-arrow' %} 
          <div class="dropdown-menu">

          </div>
      </div> 
  </div>
    <div class="collection-grid-and-filter">
      <div class="selected-filters-desktop"></div>
      
        {% paginate collection.products by 6 %}
          <div class="main-collection-product-grid"> 
            {% for product in collection.products %}
              {% render 'product-card', product: product %}
            {% endfor %}
          </div>
        {% endpaginate %}
      
      <a id="show-more-btn" data-page="1" style="display:block;">Show More</a>
    </div>


  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {

  const filterForm = document.getElementById('filter-form');
  const dropdownMenu = document.querySelector('.selected-filters-dropdown .dropdown-menu');
  const dropdownToggle = document.querySelector('.selected-filters-dropdown .dropdown-toggle');
  const desktopButtonsGroup = document.querySelector('.selected-filters-desktop');
  const showMoreBtn = document.getElementById('show-more-btn');
  let page = 1; // Track current page for pagination


  const detailsElement = document.querySelector('details'); // Adjust this selector to match your details element

  function openDetailsIfDesktop() {
    // Define a breakpoint for desktop view, e.g., 768px and above
    if (window.innerWidth >= 768) {
      // Open the details section if it is not already open
      if (!detailsElement.hasAttribute('open')) {
        detailsElement.setAttribute('open', 'open');
      }
    }
  }

  // Run the function on page load
  openDetailsIfDesktop();

  // Optionally, add a listener to open the details section when resizing to desktop view
  window.addEventListener('resize', function () {
    openDetailsIfDesktop();
  });

  // Attach event listeners to all filter inputs
  filterForm.querySelectorAll('input').forEach(function (input) {
    input.addEventListener('change', function () {
     // page = 1; // Reset pagination to 1 when filters are applied
      applyFilters();
    });
  });

  function applyFilters() {
    const formData = new FormData(filterForm);

    // Fetch the collection with the applied filters using AJAX
    fetch(window.location.href.split('?')[0] + '?' + new URLSearchParams(formData).toString(), {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(response => response.text())
    .then(html => {
      // Replace the collection product grid with the new filtered content
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newContent = doc.querySelector('.main-collection-product-grid');
      const currentContent = document.querySelector('.main-collection-product-grid');

      if (newContent && currentContent) {
        currentContent.innerHTML = newContent.innerHTML;

        // Check if there are more than 6 products after filtering
        const filteredProducts = currentContent.querySelectorAll('.product-card__wrapper');
        if (filteredProducts.length <= 6) {
          showMoreBtn.style.display = 'none'; // Hide if there are 6 or fewer products
        } else {
          showMoreBtn.style.display = 'block'; // Show if more than 6
        }
      }
    })
    .catch(error => console.error('Error applying filters:', error));
  }

  document.getElementById('show-more-btn').addEventListener('click', function () {
    page += 1; // Increment the page number for each "Show More" click
    let url = `${window.location.pathname}?page=${page}`;

    fetch(url)
      .then(response => response.text())
      .then(html => {
        let parser = new DOMParser();
        let doc = parser.parseFromString(html, 'text/html');
        let newProducts = doc.querySelectorAll('.main-collection-product-grid .product-card__wrapper');

        // Append new products to the main-collection-product-grid
        newProducts.forEach(product => {
          document.querySelector('.main-collection-product-grid').appendChild(product);
        });

        // Hide the "Show More" button if fewer products are available
        if (newProducts.length < 6) {
          showMoreBtn.style.display = 'none';
        }
      });
  });

  // Initialize with the first four filters on page load
  function updateStaticFilters() {
    dropdownMenu.innerHTML = '';
    desktopButtonsGroup.innerHTML = '';

    const filterOptions = filterForm.querySelectorAll('input[type="checkbox"], input[type="radio"]');
    const firstFourOptions = Array.from(filterOptions).slice(0, 4);

    firstFourOptions.forEach(option => {
      const labelElement = option.closest('label');
      const optionLabel = labelElement ? labelElement.textContent.trim() : option.value;

      const dropdownButton = createFilterButton(option.name, option.value, optionLabel);
      const desktopButton = createFilterButton(option.name, option.value, optionLabel);

      dropdownButton.addEventListener('click', function () {
        applySelectedFilter(option.name, option.value, dropdownButton, dropdownMenu);
      });
      desktopButton.addEventListener('click', function () {
        applySelectedFilter(option.name, option.value, desktopButton, desktopButtonsGroup);
      });

      dropdownMenu.appendChild(dropdownButton);
      desktopButtonsGroup.appendChild(desktopButton);
    });

    if (firstFourOptions.length > 0) {
      const firstLabelElement = firstFourOptions[0].closest('label');
      const firstOptionLabel = firstLabelElement ? firstLabelElement.textContent.trim() : firstFourOptions[0].value;
      dropdownToggle.textContent = firstOptionLabel;
    } else {
      dropdownToggle.textContent = 'Selected Filters';
    }
  }

  function createFilterButton(name, value, label) {
    const button = document.createElement('button');
    button.className = 'button-like';
    button.textContent = label;
    button.dataset.name = name;
    button.dataset.value = value;
    return button;
  }

  function applySelectedFilter(filterName, filterValue, clickedButton, buttonContainer) {
    const formData = new FormData();
    formData.append(filterName, filterValue);

    fetch(window.location.href.split('?')[0] + '?' + new URLSearchParams(formData).toString(), {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newContent = doc.querySelector('.main-collection-product-grid');
      const currentContent = document.querySelector('.main-collection-product-grid');

      if (newContent && currentContent) {
        currentContent.innerHTML = newContent.innerHTML;

        const filteredProducts = currentContent.querySelectorAll('.product-card__wrapper');
        if (filteredProducts.length <= 6) {
          showMoreBtn.style.display = 'none';
        } else {
          showMoreBtn.style.display = 'block';
        }
      }

      buttonContainer.querySelectorAll('.button-like').forEach(btn => btn.classList.remove('active'));
      clickedButton.classList.add('active');
    })
    .catch(error => console.error('Error applying filter:', error));
  }

  // Initialize static filters and dropdown behavior
  updateStaticFilters();
  dropdownToggle.addEventListener('click', function () {
    dropdownMenu.style.display = dropdownMenu.style.display === 'flex' ? 'none' : 'flex';
  });
  });
</script>



{% schema %}
  {
    "name": "t:sections.main-collection-product-grid.name",
    "class": "section",
    "settings": [
      {
        "type": "product",
        "id": "product",
        "label": "Product"
      },
      {
        "type": "color_scheme",
        "id": "section_color_scheme",
        "label": "t:sections.all.colors.label",
        "default": "scheme-1"
      },
      {
        "type": "color_scheme",
        "id": "color_scheme",
        "label": "t:sections.multirow.settings.container_color_scheme.label",
        "default": "scheme-1"
      },
      {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ]
  }
{% endschema %}